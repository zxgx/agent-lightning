
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://microsoft.github.io/agent-lightning/latest/algorithm-zoo/apo/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../verl/">
      
      
      <link rel="icon" href="../../assets/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>APO - Agent-lightning</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="agl" data-md-color-accent="agl">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#apo" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Agent-lightning" class="md-header__button md-logo" aria-label="Agent-lightning" data-md-component="logo">
      
  <img src="../../assets/favicon-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Agent-lightning
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              APO
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="agl" data-md-color-accent="agl"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="agl" data-md-color-accent="agl"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/microsoft/agent-lightning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agent-lightning
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Agent-lightning" class="md-nav__button md-logo" aria-label="Agent-lightning" data-md-component="logo">
      
  <img src="../../assets/favicon-white.svg" alt="logo">

    </a>
    Agent-lightning
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/microsoft/agent-lightning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agent-lightning
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Quickstart
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/train-first-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train the First Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/write-first-algorithm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Write the First Algorithm
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    How-To Recipes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            How-To Recipes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/unsloth-sft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SFT with Unsloth
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/train-sql-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train SQL Agent with RL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Learning More
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Learning More
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/write-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Write Agents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/debug/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with Traces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/parallelize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parallelize
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Algorithm Zoo
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Algorithm Zoo
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    APO
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    APO
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      Installation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scope-of-current-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Scope of Current Implementation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      Initial Prompt
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorials-using-apo" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorials Using APO
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
    <nav class="md-nav" aria-label="References">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;apo
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" apo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;APO
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" APO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.compute_textual_gradient" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;compute_textual_gradient
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.evaluate_prompt_on_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;evaluate_prompt_on_batch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.get_adapter" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_adapter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.get_best_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_best_prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.get_rollout_results" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_rollout_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.get_seed_prompt_template" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_seed_prompt_template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.run" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.textual_gradient_and_apply_edit" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;textual_gradient_and_apply_edit
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../verl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VERL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Deep Dive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Deep Dive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deep-dive/birds-eye-view/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bird's Eye View
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deep-dive/store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Understanding Store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deep-dive/serving-llm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Serving LLM
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API References
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            API References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/algorithm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Algorithm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Command Line
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/instrumentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instrumentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/trainer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trainer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/internal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Internal
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      Installation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scope-of-current-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Scope of Current Implementation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      Initial Prompt
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorials-using-apo" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorials Using APO
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
    <nav class="md-nav" aria-label="References">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;apo
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" apo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;APO
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" APO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.compute_textual_gradient" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;compute_textual_gradient
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.evaluate_prompt_on_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;evaluate_prompt_on_batch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.get_adapter" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_adapter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.get_best_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_best_prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.get_rollout_results" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_rollout_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.get_seed_prompt_template" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_seed_prompt_template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.run" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.apo.APO.textual_gradient_and_apply_edit" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;textual_gradient_and_apply_edit
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  <div id="version-warning" class="version-warning" style="display: none;">
    ⚠️ You are viewing development documentation. For stable documentation, please visit
    <a href="https://microsoft.github.io/agent-lightning/stable/">https://microsoft.github.io/agent-lightning/stable/</a>
  </div>
  
                  <!-- Copied and modified from https://github.com/squidfunk/mkdocs-material/blob/master/src/templates/partials/content.html -->

<!-- Tags -->



<!-- Actions -->

  
  


<!--
  Hack: check whether the content contains a h1 headline. If it doesn't, the
  page title (or respectively site name) is used as the main headline.
-->


<!-- Source file information -->







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="October 16, 2025 07:01:39 UTC"><span class="timeago" datetime="2025-10-16T07:01:39+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="October 16, 2025 07:01:39 UTC">2025-10-16</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="October 15, 2025 05:37:44 UTC"><span class="timeago" datetime="2025-10-15T05:37:44+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="October 15, 2025 05:37:44 UTC">2025-10-15</span>
  </span>

    
    
      
  
  <span class="md-source-file__fact">
    <span class="md-icon" title="Contributors">
      
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"/></svg>
      
    </span>
    <nav>
      
        <a href="mailto:yuge.zhang@microsoft.com">Yuge Zhang</a>
    </nav>
  </span>

    
    
  </aside>


<!-- Page content -->
<h1 id="apo">APO<a class="headerlink" href="#apo" title="Permanent link">&para;</a></h1>
<div class="admonition tip">
<p class="admonition-title">Shortcut</p>
<p>You can use the shortcut <code>agl.APO(...)</code> to create an APO instance.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">agentlightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">agl</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">agl</span><span class="o">.</span><span class="n">APO</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>pip<span class="w"> </span>install<span class="w"> </span>agentlightning<span class="o">[</span>apo<span class="o">]</span>
</code></pre></div>
<h2 id="scope-of-current-implementation">Scope of Current Implementation<a class="headerlink" href="#scope-of-current-implementation" title="Permanent link">&para;</a></h2>
<p>APO is currently scoped to optimize a single prompt template. Optimizing multiple prompt templates is not supported yet.</p>
<p>There is however no restriction on the number of variable placeholders in the prompt template (can range from zero to many). It's possible that invalid prompts are created during the optimization process. It is up to the agent developer to ensure that the prompt template is valid for the agent's task.</p>
<h2 id="initial-prompt">Initial Prompt<a class="headerlink" href="#initial-prompt" title="Permanent link">&para;</a></h2>
<p>APO expects the initial prompt to be provided in the <code>initial_resources</code> dictionary. This can be done in two approaches:</p>
<ol>
<li>Pass to the <a class="autorefs autorefs-internal" title="            agentlightning.Trainer" href="../../reference/trainer/#agentlightning.Trainer">Trainer</a> constructor:</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">trainer</span> <span class="o">=</span> <span class="n">agl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="n">algorithm</span><span class="o">=</span><span class="n">agl</span><span class="o">.</span><span class="n">APO</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">initial_resources</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;main_prompt&quot;</span><span class="p">:</span> <span class="n">agl</span><span class="o">.</span><span class="n">PromptTemplate</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;f-string&quot;</span><span class="p">)},</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="p">)</span>
</code></pre></div>
<ol>
<li>Pass to the <code>[APO][agentlightning.algorithm.apo.APO].set_initial_resources()</code> method:</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">agl</span><span class="o">.</span><span class="n">APO</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">algo</span><span class="o">.</span><span class="n">set_initial_resources</span><span class="p">(</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="p">{</span><span class="s2">&quot;this_is_also_valid_key&quot;</span><span class="p">:</span> <span class="n">agl</span><span class="o">.</span><span class="n">PromptTemplate</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;f-string&quot;</span><span class="p">)}</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="p">)</span>
</code></pre></div>
<p>The resource key can be arbitrary, which is used to identify the prompt template in <a href="../../tutorials/write-agents/">class-based implementations</a> when you have multiple resources. When the key changes, the agent developer needs to update the key in the <code>rollout</code> method.</p>
<h2 id="tutorials-using-apo">Tutorials Using APO<a class="headerlink" href="#tutorials-using-apo" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../../how-to/train-first-agent/">Train the First Agent with APO</a> - A step-by-step guide to training your first agent using APO.</li>
</ul>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<h3 id="agentlightning.algorithm.apo" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>agentlightning.algorithm.apo</code>


<a href="#agentlightning.algorithm.apo" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h4 id="agentlightning.algorithm.apo.APO" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>APO</code>


<a href="#agentlightning.algorithm.apo.APO" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            agentlightning.Algorithm (agentlightning.algorithm.base.Algorithm)" href="../../reference/algorithm/#agentlightning.Algorithm">Algorithm</a></code>, <code><span title="typing.Generic">Generic</span>[<span title="agentlightning.algorithm.apo.apo.T_task">T_task</span>]</code></p>


        <p>Automatic Prompt Optimization (APO) algorithm using textual gradients and beam search.</p>
<p>APO is an iterative prompt optimization algorithm that uses LLM-generated textual gradients
to improve prompts through a beam search process. It evaluates prompts on rollouts,
computes critiques based on the results, and applies edits to generate improved prompts.</p>
<p>The algorithm operates in rounds, where each round:</p>
<ol>
<li>Samples parent prompts from the current beam</li>
<li>Generates new prompts by computing textual gradients and applying edits</li>
<li>Evaluates all candidates on a validation set</li>
<li>Selects the top-k prompts for the next round</li>
</ol>
<p>Based on the ideas from:</p>
<ul>
<li><a href="https://aclanthology.org/2023.emnlp-main.494.pdf">ProTeGi</a></li>
<li><a href="https://github.com/zou-group/textgrad">TextGrad</a></li>
</ul>











  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="agentlightning.algorithm.apo.APO.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">async_openai_client</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">gradient_model</span><span class="o">=</span><span class="s1">&#39;gpt-5-mini&#39;</span><span class="p">,</span> <span class="n">apply_edit_model</span><span class="o">=</span><span class="s1">&#39;gpt-4.1-mini&#39;</span><span class="p">,</span> <span class="n">diversity_temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gradient_batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">val_batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">beam_width</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">branch_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">beam_rounds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rollout_batch_timeout</span><span class="o">=</span><span class="mf">3600.0</span><span class="p">,</span> <span class="n">run_initial_validation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_poml_trace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#agentlightning.algorithm.apo.APO.__init__" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

        <p>Initialize the APO algorithm with configuration parameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>async_openai_client</code></b>
              (<code><span title="openai.AsyncOpenAI">AsyncOpenAI</span></code>)
          –
          <div class="doc-md-description">
            <p>AsyncOpenAI client for making LLM API calls.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>gradient_model</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;gpt-5-mini&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>Model name for computing textual gradients (critiques).</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>apply_edit_model</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;gpt-4.1-mini&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>Model name for applying edits based on critiques.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>diversity_temperature</code></b>
              (<code><span title="float">float</span></code>, default:
                  <code>1.0</code>
)
          –
          <div class="doc-md-description">
            <p>Temperature parameter for LLM calls to control diversity.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>gradient_batch_size</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>4</code>
)
          –
          <div class="doc-md-description">
            <p>Number of rollout results to sample for gradient computation.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>val_batch_size</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>16</code>
)
          –
          <div class="doc-md-description">
            <p>Number of validation examples to use for evaluation.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>beam_width</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>4</code>
)
          –
          <div class="doc-md-description">
            <p>Number of top-scoring prompts to keep in the beam at each round.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>branch_factor</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>4</code>
)
          –
          <div class="doc-md-description">
            <p>Number of new prompt candidates to generate from each parent prompt
by applying textual gradient edits. This controls the expansion of the search tree.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>beam_rounds</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>3</code>
)
          –
          <div class="doc-md-description">
            <p>Number of beam search rounds to perform.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>rollout_batch_timeout</code></b>
              (<code><span title="float">float</span></code>, default:
                  <code>3600.0</code>
)
          –
          <div class="doc-md-description">
            <p>Maximum time in seconds to wait for rollout batch completion.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>run_initial_validation</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>True</code>
)
          –
          <div class="doc-md-description">
            <p>If True, runs validation on the seed prompt before starting
optimization to establish a baseline score. Defaults to True.</p>
          </div>
        </li>
    </ul>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="agentlightning.algorithm.apo.APO.compute_textual_gradient" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute_textual_gradient</span><span class="p">(</span><span class="n">current_prompt</span><span class="p">,</span> <span class="n">rollout_results</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.algorithm.apo.APO.compute_textual_gradient" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

        <p>Compute a textual gradient (critique) for the current prompt based on rollout results.</p>
<p>This method samples rollout results, sends them to an LLM along with the current prompt,
and generates a critique describing how the prompt could be improved.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>current_prompt</code></b>
              (<code><span title="agentlightning.algorithm.apo.apo.VersionedPromptTemplate">VersionedPromptTemplate</span></code>)
          –
          <div class="doc-md-description">
            <p>The prompt template to critique.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>rollout_results</code></b>
              (<code><span title="typing.List">List</span>[<span title="agentlightning.algorithm.apo.apo.RolloutResultForAPO">RolloutResultForAPO</span>]</code>)
          –
          <div class="doc-md-description">
            <p>List of rollout results containing spans, messages, and rewards.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
          –
          <div class="doc-md-description">
            <p>A textual critique generated by the LLM, or None if generation fails.</p>
          </div>
        </li>
    </ul>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="agentlightning.algorithm.apo.APO.evaluate_prompt_on_batch" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">evaluate_prompt_on_batch</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.algorithm.apo.APO.evaluate_prompt_on_batch" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

        <p>Evaluate a prompt on a batch of tasks by running rollouts and computing average reward.</p>
<p>This method:</p>
<ol>
<li>Adds the prompt as a named resource to the store</li>
<li>Enqueues rollouts for each task in the dataset</li>
<li>Waits for rollouts to complete (with timeout)</li>
<li>Computes and returns the average reward</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>prompt</code></b>
              (<code><span title="agentlightning.algorithm.apo.apo.VersionedPromptTemplate">VersionedPromptTemplate</span></code>)
          –
          <div class="doc-md-description">
            <p>The prompt template string to evaluate.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>resource_name</code></b>
              (<code><span title="str">str</span></code>)
          –
          <div class="doc-md-description">
            <p>The name to register the prompt under in the store.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>dataset</code></b>
              (<code><span title="typing.Sequence">Sequence</span>[<span title="agentlightning.algorithm.apo.apo.T_task">T_task</span>]</code>)
          –
          <div class="doc-md-description">
            <p>Sequence of tasks to evaluate the prompt on.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>mode</code></b>
              (<code><a class="autorefs autorefs-internal" title="            agentlightning.RolloutMode = Literal['train', 'val', 'test']

  
      module-attribute
   (agentlightning.types.RolloutMode)" href="../../reference/types/#agentlightning.RolloutMode">RolloutMode</a></code>)
          –
          <div class="doc-md-description">
            <p>Rollout mode ("train" or "val") for logging/tracking.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="typing.List">List</span>[<span title="agentlightning.algorithm.apo.apo.RolloutResultForAPO">RolloutResultForAPO</span>]</code>
          –
          <div class="doc-md-description">
            <p>A tuple of (rollout_results, average_reward) where rollout_results contains</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
              <code><span title="float">float</span></code>
          –
          <div class="doc-md-description">
            <p>detailed information for each rollout and average_reward is the mean final reward.</p>
          </div>
        </li>
    </ul>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="agentlightning.algorithm.apo.APO.get_adapter" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_adapter</span><span class="p">()</span></code>

<a href="#agentlightning.algorithm.apo.APO.get_adapter" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

        <p>Get the adapter for converting spans to messages.</p>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><a class="autorefs autorefs-internal" title="            agentlightning.TraceToMessages (agentlightning.adapter.messages.TraceToMessages)" href="../../reference/algorithm/#agentlightning.TraceToMessages">TraceToMessages</a></code>
          –
          <div class="doc-md-description">
            <p>The TraceToMessages instance for this algorithm.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="ValueError">ValueError</span></code>
            –
          <div class="doc-md-description">
            <p>If the adapter is not a TraceToMessages.</p>
          </div>
        </li>
    </ul>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="agentlightning.algorithm.apo.APO.get_best_prompt" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_best_prompt</span><span class="p">()</span></code>

<a href="#agentlightning.algorithm.apo.APO.get_best_prompt" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

        <p>Retrieve the best prompt discovered during optimization.</p>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><a class="autorefs autorefs-internal" title="            agentlightning.PromptTemplate (agentlightning.types.PromptTemplate)" href="../../reference/types/#agentlightning.PromptTemplate">PromptTemplate</a></code>
          –
          <div class="doc-md-description">
            <p>The prompt template with the highest validation score found so far.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="ValueError">ValueError</span></code>
            –
          <div class="doc-md-description">
            <p>If no best prompt has been found yet (run() not called).</p>
          </div>
        </li>
    </ul>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="agentlightning.algorithm.apo.APO.get_rollout_results" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_rollout_results</span><span class="p">(</span><span class="n">rollout</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.algorithm.apo.APO.get_rollout_results" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

        <p>Convert completed rollouts to APO-compatible result format.</p>
<p>Fetches spans for each rollout, adapts them to messages, and packages them
with rewards and status information for gradient computation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>rollout</code></b>
              (<code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="            agentlightning.Rollout (agentlightning.types.Rollout)" href="../../reference/types/#agentlightning.Rollout">Rollout</a>]</code>)
          –
          <div class="doc-md-description">
            <p>List of completed rollout metadata.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="typing.List">List</span>[<span title="agentlightning.algorithm.apo.apo.RolloutResultForAPO">RolloutResultForAPO</span>]</code>
          –
          <div class="doc-md-description">
            <p>List of rollout results formatted for APO processing.</p>
          </div>
        </li>
    </ul>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="agentlightning.algorithm.apo.APO.get_seed_prompt_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_seed_prompt_template</span><span class="p">()</span></code>

<a href="#agentlightning.algorithm.apo.APO.get_seed_prompt_template" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

        <p>Extract the initial prompt template from the algorithm's resources.</p>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="typing.Tuple">Tuple</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="            agentlightning.PromptTemplate (agentlightning.types.PromptTemplate)" href="../../reference/types/#agentlightning.PromptTemplate">PromptTemplate</a>]</code>
          –
          <div class="doc-md-description">
            <p>A tuple of (resource_name, prompt_template) representing the seed prompt.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="ValueError">ValueError</span></code>
            –
          <div class="doc-md-description">
            <p>If initial_resources is not set or no PromptTemplate is found.</p>
          </div>
        </li>
    </ul>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="agentlightning.algorithm.apo.APO.run" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.algorithm.apo.APO.run" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

        <p>Execute the APO algorithm to optimize prompts through beam search with textual gradients.</p>
<p>The algorithm performs iterative prompt optimization over multiple rounds:</p>
<ul>
<li>Each round: samples parent prompts, generates new candidates via textual gradients,
  evaluates all candidates on validation data, and keeps the top performers</li>
<li>Tracks the historically best prompt across all rounds</li>
<li>Uses different training data samples for each gradient computation to ensure diversity</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>train_dataset</code></b>
              (<code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="            agentlightning.Dataset (agentlightning.types.Dataset)" href="../../reference/types/#agentlightning.Dataset">Dataset</a>[<span title="agentlightning.algorithm.apo.apo.T_task">T_task</span>]]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>Dataset of tasks for computing textual gradients. Required.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>val_dataset</code></b>
              (<code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="            agentlightning.Dataset (agentlightning.types.Dataset)" href="../../reference/types/#agentlightning.Dataset">Dataset</a>[<span title="agentlightning.algorithm.apo.apo.T_task">T_task</span>]]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>Dataset of tasks for evaluating and selecting prompts. Required.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="ValueError">ValueError</span></code>
            –
          <div class="doc-md-description">
            <p>If train_dataset or val_dataset is None, or if resources are not set.</p>
          </div>
        </li>
    </ul>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="agentlightning.algorithm.apo.APO.textual_gradient_and_apply_edit" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">textual_gradient_and_apply_edit</span><span class="p">(</span><span class="n">current_prompt</span><span class="p">,</span> <span class="n">rollout</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.algorithm.apo.APO.textual_gradient_and_apply_edit" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

        <p>Generate an improved prompt by computing a textual gradient and applying an edit.</p>
<p>This is the main optimization step that:</p>
<ol>
<li>Computes a critique (textual gradient) based on rollout performance</li>
<li>Uses another LLM to apply the critique and generate an improved prompt</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>current_prompt</code></b>
              (<code><span title="agentlightning.algorithm.apo.apo.VersionedPromptTemplate">VersionedPromptTemplate</span></code>)
          –
          <div class="doc-md-description">
            <p>The current prompt template to improve.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>rollout</code></b>
              (<code><span title="typing.List">List</span>[<span title="agentlightning.algorithm.apo.apo.RolloutResultForAPO">RolloutResultForAPO</span>]</code>)
          –
          <div class="doc-md-description">
            <p>List of rollout results to base the critique on.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
          –
          <div class="doc-md-description">
            <p>The improved prompt text, or the original prompt if gradient computation fails.</p>
          </div>
        </li>
    </ul>


    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<!-- Was this page helpful? -->




<!-- Comment system -->

                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script>
    
    
  
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="https://unpkg.com/chart.js@4.5.1/dist/chart.umd.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
        <script src="../../javascripts/charts.js"></script>
      
        <script src="../../javascripts/move-source-file.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
    
  <script>
    // Show warning banner if not viewing stable documentation
    document.addEventListener("DOMContentLoaded", function() {
      const currentURL = window.location.href;
      const warningDiv = document.getElementById("version-warning");

      // Check if we're on the stable docs or the redirect page
      if (currentURL.includes('agent-lightning/latest/')) {
        // Show warning for explicitly latest docs
        warningDiv.style.display = "block";
      }
    });
  </script>

  </body>
</html>